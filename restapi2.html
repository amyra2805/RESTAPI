<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Products Manager (Add / Edit / Delete)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: Inter, system-ui, Arial, sans-serif;
        background: #f5f7fb;
        color: #111827;
      }
      table th,
      table td {
        text-align: left;
        padding: 0.75rem;
        border-bottom: 1px solid #e5e7eb;
      }
      .toast-container {
        position: fixed;
        top: 6rem; /* adjust to appear above table */
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        z-index: 80;
        pointer-events: none;
      }
      .toast {
        pointer-events: auto;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 600;
        color: white;
        transform-origin: top right;
        transition: transform 180ms ease, opacity 180ms ease;
      }
      .toast.hide {
        opacity: 0;
        transform: translateY(-6px) scale(0.98);
      }
      .toast.success {
        background: linear-gradient(90deg, #059669, #10b981);
      }
      .toast.error {
        background: linear-gradient(90deg, #dc2626, #ef4444);
      }
      /* Modal overlay hidden by default */
      .modal-backdrop {
        display: none;
        position: fixed;
        inset: 0;
        z-index: 50;
        background: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
        padding: 1rem;
      }
      .modal-backdrop.show {
        display: flex;
      }
    </style>
  </head>
  <body class="p-6">
    <!-- Topbar -->
    <div class="flex justify-between items-center mb-4">
      <div class="text-xl font-semibold">Restful-API</div>
      <div class="flex gap-2">
        <button
          id="loadBtn"
          class="px-3 py-1 rounded border bg-white hover:bg-gray-50"
        >
          ⟳ Load Products
        </button>
        <button
          id="addBtn"
          class="px-3 py-1 rounded bg-purple-600 text-white hover:bg-purple-700"
        >
          ＋ Add Product
        </button>
      </div>
    </div>

    <!-- Table Card -->
    <div class="bg-white rounded-lg shadow p-4">
      <table class="w-full">
        <thead>
          <tr>
            <th class="w-1/6">ID</th>
            <th>Product</th>
            <th class="w-1/5">Action</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <!-- Add/Edit Modal -->
    <div id="productModalBackdrop" class="modal-backdrop">
      <div
        class="bg-white rounded-lg shadow-lg max-w-lg w-full overflow-hidden"
      >
        <div class="p-6">
          <h2 id="modalTitle" class="text-lg font-semibold mb-4">
            Add Product
          </h2>
          <form id="modalForm">
            <label class="block font-medium mb-2">Product Name</label>
            <input
              id="productName"
              type="text"
              autocomplete="off"
              class="w-full border rounded px-3 py-2 mb-2"
            />
            <p id="modalError" class="text-red-600 text-sm mb-2 hidden">
              Error message
            </p>
            <div class="flex justify-end gap-2 mt-4">
              <button
                type="button"
                id="cancelBtn"
                class="px-3 py-1 rounded border hover:bg-gray-50"
              >
                Cancel
              </button>
              <button
                type="submit"
                id="saveBtn"
                class="px-3 py-1 rounded bg-purple-600 text-white hover:bg-purple-700"
              >
                Save
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="confirmModalBackdrop" class="modal-backdrop">
      <div
        class="bg-white rounded-lg shadow-lg max-w-md w-full overflow-hidden"
      >
        <div class="p-6">
          <h2 class="text-lg font-semibold mb-4">Confirm Delete</h2>
          <p class="mb-4">
            Are you sure you want to delete this product? This action cannot be
            undone.
          </p>
          <div class="flex justify-end gap-2">
            <button
              id="cancelDelete"
              class="px-3 py-1 rounded border hover:bg-gray-50"
            >
              Cancel
            </button>
            <button
              id="confirmDelete"
              class="px-3 py-1 rounded bg-red-600 text-white hover:bg-red-700"
            >
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container" aria-hidden="true"></div>

    <script>
      const apiURL = "https://api.restful-api.dev/objects";
      const loadBtn = document.getElementById("loadBtn");
      const addBtn = document.getElementById("addBtn");
      const tableBody = document.getElementById("tableBody");

      const productModalBackdrop = document.getElementById("productModalBackdrop");
      const modalTitle = document.getElementById("modalTitle");
      const modalForm = document.getElementById("modalForm");
      const productName = document.getElementById("productName");
      const modalError = document.getElementById("modalError");
      const cancelBtn = document.getElementById("cancelBtn");
      const saveBtn = document.getElementById("saveBtn");

      const confirmModalBackdrop = document.getElementById(
        "confirmModalBackdrop"
      );
      const cancelDelete = document.getElementById("cancelDelete");
      const confirmDelete = document.getElementById("confirmDelete");

      const toastContainer = document.getElementById("toastContainer");

      let editingId = null;
      let deleteId = null;

      const showToast = (msg, type = "success", duration = 3000) => { //toast remain visible for 3 seconds
        const toast = document.createElement("div");
        toast.className = "toast " + (type === "error" ? "error" : "success");
        toast.textContent = msg;
        toastContainer.appendChild(toast);
        toastContainer.setAttribute("aria-hidden", "false");
        setTimeout(() => {
          toast.classList.add("hide");
          setTimeout(() => {
            toast.remove(); //remove from DOM because it is a temporary UI element and to not slow down the page 
            if (!toastContainer.children.length)
              toastContainer.setAttribute("aria-hidden", "true");
          }, 180);
        }, duration);
      };

      const escapeHtml = (str) =>
        str.replace(
          /[&<>"']/g,
          (m) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#039;",
            }[m])
        );

      const validateName = (raw) => {
        const value = raw;
        if (!value)
          return { valid: false, message: "Please enter a product name." };
        if (value.length > 120)
          return { valid: false, message: "Name too long." };
        return { valid: true, value };
      };

      const renderTable = (items) => {
        tableBody.innerHTML = "";
        if (!items || !items.length) return;
        items.forEach((item) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
          <td>${escapeHtml(item.id)}</td>
          <td><strong>${escapeHtml(item.name)}</strong></td>
          <td class="flex gap-2">
            <button class="px-2 py-1 border rounded text-purple-600 editBtn">Edit</button>
            <button class="px-2 py-1 border rounded text-red-600 deleteBtn">Delete</button>
          </td>`;
          tr.querySelector(".editBtn").addEventListener("click", () =>
            openModalForEdit(item.id, item.name)
          );
          tr.querySelector(".deleteBtn").addEventListener("click", () =>
            openConfirmDelete(item.id)
          );
          tableBody.appendChild(tr);
        });
      };

      const getLocal = () =>
        JSON.parse(localStorage.getItem("localProducts") || "[]");
      const setLocal = (arr) =>
        localStorage.setItem("localProducts", JSON.stringify(arr));

      const loadProducts = async () => {
        tableBody.innerHTML = '<tr><td colspan="3">Loading…</td></tr>';
        try {
          const res = await fetch(apiURL);
          if (!res.ok) throw new Error(res.status);
          const remote = await res.json();
          const local = getLocal();
          const normalize = (x) => ({
            id: String(x.id),
            name: x.name || x.data?.brand || x.data?.model || "No Name",
          });
          renderTable([...local.map(normalize), ...remote.map(normalize)]);
        } catch {
          renderTable(getLocal());
          showToast("Loaded local data", "error");
        }
      };

      // Open / Close Modals (pop up untuk add product name)
      const openModalForAdd = () => {
        editingId = null;
        modalTitle.textContent = "Add Product";
        saveBtn.textContent = "Save";
        productName.value = "";
        modalError.classList.add("hidden");
        productModalBackdrop.classList.add("show");
        productName.focus();
      };

      //pop up untuk edit product name
      const openModalForEdit = (id, name) => {
        editingId = id;
        modalTitle.textContent = "Edit Product";
        saveBtn.textContent = "Update";
        productName.value = name;
        modalError.classList.add("hidden");
        productModalBackdrop.classList.add("show");
        productName.focus();
      };
      const hideModal = () => {
        productModalBackdrop.classList.remove("show");
        editingId = null;
      };

      const openConfirmDelete = (id) => {
        deleteId = id;
        confirmModalBackdrop.classList.add("show");
      };
      const hideConfirmDelete = () => {
        confirmModalBackdrop.classList.remove("show");
        deleteId = null;
      };

      // Handle Save
      const handleSave = async (e) => {
        e.preventDefault();
        const v = validateName(productName.value);
        if (!v.valid) {
          modalError.textContent = v.message;
          modalError.classList.remove("hidden");
          return;
        }
        const name = v.value;

        if (!editingId) {
          try {
            const res = await fetch(apiURL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ name }),
            });
            if (!res.ok) throw new Error(res.status);
            const data = await res.json();
            const local = getLocal();
            local.unshift({ id: String(data.id), name: data.name || name });
            setLocal(local);
            showToast("Product created");
          } catch {
            const local = getLocal();
            local.unshift({ id: "local-" + Date.now(), name });
            setLocal(local);
            showToast("Saved locally", "error");
          } finally {
            hideModal();
            loadProducts();
          }
        } else {
          try {
            const res = await fetch(
              `${apiURL}/${encodeURIComponent(editingId)}`,
              {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name }),
              }
            );
            if (!res.ok) throw new Error(res.status);
            const local = getLocal();
            const i = local.findIndex((it) => it.id === editingId);
            if (i > -1) {
              local[i].name = name;
              setLocal(local);
            }
            showToast("Product updated");
          } catch {
            const local = getLocal();
            const i = local.findIndex((it) => it.id === editingId);
            if (i > -1) {
              local[i].name = name;
              setLocal(local);
            }
            showToast("Update Failed", "error");
          } finally {
            hideModal();
            loadProducts();
            editingId = null;
          }
        }
      };

      // Handle Delete
      const handleDelete = async () => {
        if (!deleteId) return;
        try {
          const res = await fetch(`${apiURL}/${encodeURIComponent(deleteId)}`, {   //encodeURIComponent(deleteId) ensures the ID is safely formatted for use in a URL converts special characters, spaces, and certain reserved characters into a sequence of safe characters that web servers can correctly interpret.
            method: "DELETE",
          });
          if (!res.ok) throw new Error(res.status);
          showToast("Deleted");
        } catch {
          showToast("Delete Failed", "error");
        } finally {
          const local = getLocal().filter((it) => it.id !== deleteId); //creates a new array of local products (it) that excludes the item with the deleted ID.
          setLocal(local); //update localstorage to the new array 
          hideConfirmDelete();
          loadProducts();
        }
      };

      // Event Listeners
      addBtn.addEventListener("click", openModalForAdd);
      loadBtn.addEventListener("click", loadProducts);
      cancelBtn.addEventListener("click", hideModal);
      modalForm.addEventListener("submit", handleSave);
      productName.addEventListener("input", () => {
        if (productName.value()) modalError.classList.add("hidden");
      });

      cancelDelete.addEventListener("click", hideConfirmDelete);
      confirmDelete.addEventListener("click", handleDelete);

      window.addEventListener("DOMContentLoaded", loadProducts);
    </script>
  </body>
</html>
